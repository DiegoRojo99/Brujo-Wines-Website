<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
 
	<!-- CSS -->
	<meta name="author" content="Diego Rojo">
	<title>Brujo Wines Test DB</title>

</head>
<body>

    <div>
        <h4>Reserva</h4>
        <p id="reserva-total-info"></p>
        <p>User Id:</p>
        <p id="user-id-info"></p>
        <p>Tipo de Reserva:</p>
        <p id="tipo-reserva-info"></p>
        <p>Numero de Personas:</p>
        <p id="numero-personas-info"></p>
        <p>Fecha de Reserva:</p>
        <p id="fecha-reserva-info"></p>
        <button id="cambiarReservaBtn" onclick="cambiarReserva()">Cambiar Reserva</button>
    </div>



    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="testDB.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.4.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-auth.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyBqFvsjkgTdQuinpZhAWLKPcghZa4gk0eU",
        authDomain: "brujowines.firebaseapp.com",
        databaseURL: "https://brujowines-default-rtdb.firebaseio.com",
        projectId: "brujowines",
        storageBucket: "brujowines.appspot.com",
        messagingSenderId: "1017605599237",
        appId: "1:1017605599237:web:8e99097db35e91e44eac6c",
        measurementId: "G-W6882XRRHD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Array reserva con indice
        var index=0;

        //Sacamos el usuario id
        var userId="";
        const auth = getAuth();
        auth.onAuthStateChanged((firebaseUser) => {
        if (firebaseUser) {
          userId=firebaseUser.uid;
        }
      });
        
        window.cambiarReserva=()=>{
            getReservas();
        }

        async function getReservas() {
        // Get a list of cities from your database 
            
            var arrayReservas=[];
            const reservasCol = collection(db, 'reservas').withConverter(reservasConverter);
            const reservasSnapshot = await getDocs(reservasCol);
            
            
            reservasSnapshot.forEach((doc) => {
                // doc.data() is never undefined for query doc snapshots
                if(doc.data().userId===userId){
                  arrayReservas.push(doc.data());
                }
            });
    
            var reservaActual=arrayReservas[index];
            
            console.log(reservaActual);
            
            document.getElementById("user-id-info").innerHTML=reservaActual.userId;
            document.getElementById("numero-personas-info").innerHTML=reservaActual.numeroPersonas;
            var fechaReservaActual=timeConverter(reservaActual.fechaReserva);
            document.getElementById("fecha-reserva-info").innerHTML=fechaReservaActual;

            if(reservaActual.tipo){                
                document.getElementById("tipo-reserva-info").innerHTML="Cata de Vinos";
            }else{
                document.getElementById("tipo-reserva-info").innerHTML="Visita a la bodega";
            }
            if(arrayReservas.length===index+1){
                index=0;
            }else{
                index++;
            }

            const reservasList = reservasSnapshot.docs.map(doc => doc.data());
            return 0;
        }

        getReservas();

        
    </script>
</body>
</html>